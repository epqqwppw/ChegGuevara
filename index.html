<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChegGuevara | Architect</title>
    <style>
        :root {
            --bg-deep: #05070a;
            --glass-panel: rgba(20, 25, 40, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-cyan: #64ffda;
            --accent-glow: rgba(100, 255, 218, 0.4);
            --text-main: #e6f1ff;
            --text-dim: #8892b0;
            --success: #69f0ae;
            --danger: #ff5252;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
        }

        /* --- COSMIC BACKGROUND SYSTEM --- */
        .cosmos {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(to bottom, #020c1b, #0a192f);
            overflow: hidden;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            box-shadow: 
                4vw 15vh 1px white, 18vw 35vh 1px white, 44vw 66vh 1px white,
                90vw 10vh 2px white, 55vw 45vh 1px white, 22vw 88vh 2px white,
                76vw 12vh 1px white, 12vw 55vh 1px white, 68vw 92vh 1px white,
                33vw 22vh 2px white, 85vw 75vh 1px white, 50vw 50vh 2px white;
            animation: drift 100s linear infinite;
        }
        
        .stars:nth-child(2) {
            width: 1px;
            height: 1px;
            opacity: 0.6;
            box-shadow: 
                14vw 25vh 1px #a5d8ff, 38vw 15vh 1px #a5d8ff, 64vw 86vh 1px #a5d8ff,
                20vw 90vh 1px #a5d8ff, 45vw 25vh 1px #a5d8ff, 82vw 38vh 1px #a5d8ff;
            animation: drift 150s linear infinite reverse;
        }

        .nebula {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 120%, rgba(29, 78, 216, 0.15), transparent 60%);
            animation: pulse-glow 8s ease-in-out infinite alternate;
        }

        @keyframes drift { from { transform: translateY(0); } to { transform: translateY(-100vh); } }
        @keyframes pulse-glow { from { opacity: 0.5; } to { opacity: 1; } }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(100, 255, 218, 0.3);
        }

        /* --- INPUT UI --- */
        .input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 350px;
            margin-bottom: 25px;
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .input-wrapper::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(45deg, transparent, var(--accent-cyan), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
            pointer-events: none;
        }

        .input-inner {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
        }

        textarea {
            flex: 1;
            background: transparent;
            color: var(--text-main);
            border: none;
            padding: 20px;
            padding-top: 50px;
            font-family: 'Roboto Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            min-height: 200px;
            white-space: pre-wrap;
        }

        #clearBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(100, 255, 218, 0.1);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        #clearBtn:hover {
            background: var(--accent-cyan);
            color: #000;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* --- BUTTONS --- */
        .actions {
            margin-bottom: 30px;
            flex-shrink: 0;
            perspective: 1000px;
        }

        button.compile-btn {
            position: relative;
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, #1d4ed8 0%, #2563eb 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
        }

        button.compile-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        button.compile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(37, 99, 235, 0.6);
        }

        button.compile-btn:hover::before {
            left: 100%;
        }

        button.compile-btn:active { transform: translateY(1px); }

        .status-bar {
            text-align: center;
            font-family: 'Roboto Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 1px;
            opacity: 0.6;
            margin-bottom: 20px;
        }

        #stealth-clipboard {
            position: absolute;
            left: -9999px;
            top: 0;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="cosmos">
        <div class="nebula"></div>
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
    </div>

    <div class="header">
        <h1>ChegGuevara</h1>
    </div>
    
    <div class="input-wrapper">
        <div class="input-inner">
            <button id="clearBtn" onclick="clearInput()">INITIALIZE</button>
            <textarea id="inputParams" spellcheck="false" placeholder=""></textarea>
        </div>
    </div>
    
    <div class="actions">
        <button class="compile-btn" onclick="executePayload()">Process Data</button>
    </div>

    <div class="status-bar">
        EQUATION ENGINE: ONLINE // STEALTH: ACTIVE
    </div>

    <div id="stealth-clipboard" contenteditable="true"></div>

<script>
    /**
     * CHEGGUEVARA v5.1 | Architect Edition
     * Features: Strict Equation Renderer (align*) output.
     */

    const CONFIG = {
        mathTag: 'span',
        mathAttr: 'data-math-type="mhchem"',
        unsafeCommands: ['\\mathbf', '\\mathrm', '\\phantom']
    };

    function clearInput() {
        const field = document.getElementById('inputParams');
        field.value = "";
        field.focus();
        const btn = document.getElementById('clearBtn');
        btn.innerText = "CLEARED";
        setTimeout(() => btn.innerText = "INITIALIZE", 1000);
    }

    function executePayload() {
        const inputField = document.getElementById('inputParams');
        const rawInput = inputField.value;

        if (!rawInput.trim()) {
            flashButton("NO INPUT DETECTED", "var(--danger)");
            return;
        }

        try {
            const cleanHtml = parseInput(rawInput);
            const clipboardDiv = document.getElementById('stealth-clipboard');
            clipboardDiv.innerHTML = cleanHtml;

            const range = document.createRange();
            range.selectNodeContents(clipboardDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            const success = document.execCommand('copy');

            if (success) {
                flashButton("PAYLOAD COPIED âœ…", "var(--success)");
                selection.removeAllRanges();
                clipboardDiv.innerHTML = ""; 
                setTimeout(() => { window.location.reload(); }, 1200);
            } else {
                throw new Error("Execution Blocked");
            }
        } catch (err) {
            flashButton("SYSTEM ERROR", "var(--danger)");
            alert("Clipboard Access Failed. Manual copy required.");
        }
    }

    /* --- PARSING ENGINE --- */
    
    function parseInput(input) {
        // 1. Header Hygiene
        let text = input
            .replace(/^### Step \d+:\s*/gm, '### ') 
            .replace(/^\([a-z]\) Action\s*$/gmi, '')
            .replace(/^\([a-z]\) Calculation\s*$/gmi, '')
            .replace(/^\([a-z]\) Explanation\s*$/gmi, '');

        // 2. Advanced Segmentation (Matches ```latex AND $$ blocks)
        const splitRegex = /((?:```latex[\s\S]*?```)|(?:\$\$[\s\S]*?\$\$))/g;
        
        const segments = text.split(splitRegex);
        let outputBuffer = "";

        segments.forEach(segment => {
            // DETECT CALCULATION BLOCKS
            if (segment.startsWith("```latex") || segment.startsWith("$$")) {
                let content = segment
                    .replace(/^```latex\s*/, '').replace(/\s*```$/, '')
                    .replace(/^\$\$\s*/, '').replace(/\s*\$\$$/, '');
                
                content = sanitizeLatex(content);

                // --- EQUATION RENDERER LOGIC ---
                // Convert to \begin{align*} block if it's not already
                if (!content.includes('\\begin{')) {
                    content = convertToAlignBlock(content);
                }

                // USE <P> TAG instead of <DIV> for Chegg Editor Compatibility
                // This mimics the native paragraph structure required by the Equation tool
                outputBuffer += `
                    <p style="text-align: left; margin-top: 1.5em; margin-bottom: 1.5em;">
                        <${CONFIG.mathTag} ${CONFIG.mathAttr}>${content}</${CONFIG.mathTag}>
                    </p>`;
            } 
            else {
                outputBuffer += parseTextSegment(segment);
            }
        });
        return outputBuffer;
    }

    /**
     * Converts raw multi-line equations into \begin{align*} ... \end{align*}
     * This format is EXACTLY what the Chegg Equation Renderer produces.
     */
    function convertToAlignBlock(rawContent) {
        const lines = rawContent.split('\n');
        let alignedLines = lines.map(line => {
            let trimLine = line.trim();
            if (!trimLine) return '';

            // Auto-Align at Equals
            if (trimLine.startsWith('=')) {
                return '&' + trimLine; 
            }
            else if (trimLine.includes('=')) {
                return trimLine.replace('=', '&=');
            }
            return trimLine;
        }).filter(line => line !== '');

        return `\\begin{align*}\n${alignedLines.join(' \\\\\n')}\n\\end{align*}`;
    }

    function parseTextSegment(segment) {
        const lines = segment.split('\n');
        let html = '';
        let listStack = [];

        const closeList = () => {
            const popped = listStack.pop();
            html += `</${popped.type}>`;
        };

        lines.forEach(line => {
            if (!line.trim()) return;

            const indentMatch = line.match(/^(\s*)/);
            const indentLevel = indentMatch ? indentMatch[1].replace(/\t/g, '    ').length : 0;
            const listMatch = line.trim().match(/^([\*\-]|\d+\.)\s+(.*)/);

            if (listMatch) {
                const marker = listMatch[1];
                const content = listMatch[2];
                const type = (marker.includes('.') || /^\d/.test(marker)) ? 'ol' : 'ul';

                if (listStack.length === 0 || indentLevel > listStack[listStack.length - 1].indent) {
                    html += `<${type}>`;
                    listStack.push({ type, indent: indentLevel });
                } else {
                    while (listStack.length > 0 && indentLevel < listStack[listStack.length - 1].indent) {
                        closeList();
                    }
                    if (listStack.length > 0 && listStack[listStack.length - 1].type !== type) {
                        closeList();
                        html += `<${type}>`;
                        listStack.push({ type, indent: indentLevel });
                    }
                }
                html += `<li>${formatInline(content)}</li>`;
            } else {
                while (listStack.length > 0) closeList();
                let cleanLine = line.trim();
                
                if (cleanLine.startsWith('### ')) {
                    const headerContent = cleanLine.replace('### ', '');
                    html += `<h3 style="margin: 0; padding-bottom: 4px;">${formatInline(headerContent)}</h3>`;
                } else {
                    html += `<p style="margin-top: 0; margin-bottom: 1em;">${formatInline(cleanLine)}</p>`;
                }
            }
        });

        while (listStack.length > 0) closeList();
        return html;
    }

    function formatInline(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>') 
            .replace(/\$([^$]+?)\$/g, (m, math) => 
                `<${CONFIG.mathTag} ${CONFIG.mathAttr}>${sanitizeLatex(math)}</${CONFIG.mathTag}>`
            );
    }

    function sanitizeLatex(latex) {
        let clean = latex;
        CONFIG.unsafeCommands.forEach(cmd => { clean = clean.split(cmd).join(''); });
        clean = clean.replace(/\\right(?!arrow)/g, '');
        clean = clean.replace(/\\left/g, '');
        clean = clean.replace(/(?<!\\)%/g, '\\%');
        return clean.trim();
    }

    function flashButton(text, bg) {
        const btn = document.querySelector('.compile-btn');
        const originalText = btn.innerText;
        const originalBg = getComputedStyle(btn).background;
        
        btn.innerText = text;
        btn.style.background = bg;
        
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.background = originalBg;
        }, 3000);
    }
</script>

</body>
</html>
